{% extends "layout.html" %}

{% block content %}

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="{{ url_for('static', filename='js/c3.min.js') }}"></script>

<br>
<div class="container-fluid col-md-custom col-md-offset-custom">
  <div class="row text-center">
  </div>

<!-- Add Bug Modal -->
<div id="add_bug_modal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title" id="modal-title">Add a new bug</h4>
      </div>
      <div class="modal-body">


                <div class="btn-group" data-toggle="buttons">
                <label class="btn btn-danger active" style="height:35px; width:105px; font-size: 120%;">
                  <input type="radio" name="options" id="option1" autocomplete="off" checked > Bugzilla
                </label>
                </div>

                <br><br>

                <div class="input-group col-xs-4" style="white-space: pre-line;">
                  <span class="input-group-addon">#</span>
                  <input id="bug_num" type="text" class="form-control" placeholder="Bug number">
                </div> 

                <div class="input-group col-xs-8" style="white-space: pre-line;">
                  <span class="input-group-addon">Job Name</span>
                  <input id="job_name" type="text" class="form-control" disabled>
                </div> 

                <br>

                Apply on all tests in the class  <input type="checkbox" data-toggle="toggle" style="margin-left: 15px;">

                <br><br>
                <button type="button" onClick="submit_bug()" class="btn btn-primary" style="height:35px; width:105px; font-size: 120%;">Add bug</button>
                <br><br>
                <div class="alert alert-danger hidden" id="bug_alert_div" style="white-space: pre-line;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

<!-- Failure Modal -->
<div id="failure_modal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title" id="modal-title">Modal Header</h4>
      </div>
      <div class="modal-body">
              <div id="failure_info_div">
              </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

<!-- Bugs Modal -->
<div id="bugs_modal" class="modal fade" role="dialog">
  <div class="modal-dialog modal-lg" style="width:1250px;">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title" id="modal-title-bugs">Modal Header</h4>
      </div>
      <div class="modal-body">
              <div id="bugs_body_div">
        <table id="bugs_table" class="table table-striped table-bordered table-hover">
          <thead>
            <tr>
                <th>Summary</th>
                <th>Number</th>
                <th>Status</th>
                <th>System</th>
                <th>Action</th>
            </tr>
          </thead>
        </table>
              </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

<!-- Tests Modal -->
<div id="tests_modal" class="modal fade" role="dialog">
  <div class="modal-dialog modal-lg" style="width:1250px;">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title" id="modal-title-tests">Modal Header</h4>
      </div>
      <div class="modal-body">
              <div id="tests_body_div">
        <table id="tests_table" class="table table-striped table-bordered table-hover">
          <thead>
            <tr>
                <th>Class Name</th>
                <th>Test Name</th>
                <th>Status</th>
                <th>Bugs</th>
            </tr>
          </thead>
        </table>
              </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

<table id="dfg_jobs_table" class="table table-striped table-bordered table-hover hidden">
        <thead>
            <tr>
                <th>Job Name</th>
                <th>Last Build Status</th>
                <th>Last Build Number</th>
                <th>Tests</th>
                <th id="bugs_th">Bugs</th>
            </tr>
        </thead>
</table>

<div class="container-fluid">
<!-- Pie chart for each release -->
{% for release in releases %}

{% include "DFG_pie_chart.html" -%}

{% endfor %}
</div>
<!-- -->

  <div class="container-fluid">
      <div class="row">
          <h3>
              <strong>Failing Tests</strong>
          </h3>
          <table class="table table-striped table-bordered table-hover" id="failed_tests_table">
            <thead>
              <tr>
                <th>Class Name</th>
                <th>Test Name</th>
                <th>Job Name</th>
                <th>Build Number</th>
                <th>Status</th>
                <th>Bugs</th>
              </tr>
            </thead>
          </table>
      </div>
  </div>

<script>

function reply_click(job, build)
{
  $.ajax({
    type:"GET",
    dataType: "json",
    data: {'job': job, 'build': build},
    url: "{{ url_for('builds.get_failure') }}",
    success: function(response){
      document.getElementById("modal-title").innerHTML = job + "  Build#" + build ;
      var div = document.getElementById('failure_info_div');
      div.innerHTML = "";
      div.innerHTML += "<div class='alert alert-danger'>Found the failure: " + response.failure_text + "</div>";
      div.innerHTML += "<br>";
      div.innerHTML += "<div class='alert alert-info'>Cause: " + response.failure_cause + "</div>";
      div.innerHTML += "<br>";
      div.innerHTML += "<div class='alert alert-success'> Suggested action: " + response.failure_action + "</div>";
      $("#failure_modal").modal();
    }
  });

}

function show_bugs(job)
{
      $('#bugs_table').DataTable( {
        "ajax": {
          "data": {'job': job},
          "url": "{{ url_for('home.get_bugs_datatable') }}",
        },
        "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
            if ( aData[2] == "CLOSED" )
            {
            $('td', nRow).css('background-color', '#f2dede');
            }
        },
        columnDefs: [
            {
                targets:[4],
                className: "text-center",
                render: function ( data, type, row, meta ) {
                        data = '<button type="button" onClick="remove_bug(\'' + row[1] + '\')" class="btn btn-info btn-lg">remove</button>'
                        return data;
                }
            },
          ],
      });

      document.getElementById("modal-title-bugs").innerHTML = job + "  bugs";
      $("#bugs_modal").modal();
}

function add_bug(job, build, id)
{
      var s = document.getElementById("job_name");
      s.value = id;
      $("#add_bug_modal").modal();
      $("#bug_alert_div").addClass('hidden');
}


function submit_bug()
{
  var bug_num = document.getElementById("bug_num").value;
  var bug_cell_id = document.getElementById("job_name").value;
  $("#bug_alert_div").addClass('hidden');

  $.ajax({
    type:"GET",
    dataType: "json",
    data: {'bug_num': bug_num, 'job_name': bug_cell_id},
    url: "{{ url_for('home.bug_exists') }}",
    success: function(response){
      if (response.exists) {
      $( "<button type='button' style='margin-right: 5px;' class='btn btn-danger'>" + bug_num + "</button>" ).insertAfter( "#" + bug_cell_id );
      $("#add_bug_modal").modal('hide');
      }
  else {
        $("#bug_alert_div").removeClass('hidden');
        $("#bug_alert_div").text("Couldn't find such bug");
  }
    }
  });
}

function show_tests(job, build)
{
      $('#tests_table').DataTable( {
        "ajax": {
          "data": {'job': job, 'build': build},
          "url": "{{ url_for('tests.get_tests_datatable') }}",
        },
        "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
            if ( aData[2] == "PASSED" )
            {
            $('td', nRow).css('background-color', '#dff0d8');
            }
            else if ( aData[2] == "FAILED" || aData[2] == "REGRESSION" )
            {
            $('td', nRow).css('background-color', '#f2dede' );
            }
            else
            {
            $('td', nRow).css('background-color', '#d9edf7');
            }
          },
        columnDefs: [
            {
                targets:[0, 1],
                className: "text-center",
                render: function ( data, type, row, meta ) {
                    if(type === 'display' && data != 'No tests'){
                        replacement = '/';
                        old_class_name = row[0];
                        old_test_name = row[1];
                        class_name = old_class_name.replace(/\.([^\.]*)$/,replacement+'$1');
                        var test_name = old_test_name.replace(/-/g, "_").replace('[', '_').replace(']', '_').replace(/,/g, "_").replace(/ /g,"_").replace(/\(/g, "_").replace(/\)/g, "_");
                        data = '<a href="{{ agent.url }}/job/' + job + '/' + build + '/testReport/' + class_name + '/' + test_name + '">' + data + '</a>';
                    }
                    return data;
                }
            },
          ],
      });
      document.getElementById("modal-title-tests").innerHTML = job + "  Build#" + build;
      $("#tests_modal").modal();

}

    $('#failed_tests_table').DataTable( {
        "ajax": "{{ url_for('tests.failing_tests_dfg', dfg=dfg) }}",
    "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
        $('td', nRow).css('background-color', '#f2dede' );
    },
    columnDefs: [
            {
                targets:[0, 1],
                className: "text-center",
                render: function ( data, type, row, meta ) {
                    if(type === 'display' && data != 'No tests'){
                        replacement = '/';
                        old_class_name = row[0];
                        old_test_name = row[1];
                        class_name = old_class_name.replace(/\.([^\.]*)$/,replacement+'$1');
                        var test_name = old_test_name.replace(/-/g, "_").replace('[', '_').replace(']', '_').replace(/,/g, "_").replace(/ /g,"_").replace(/\(/g, "_").replace(/\)/g, "_");
                        data = '<a href="{{ agent.url }}/job/' + row[2] + '/' + row[3] + '/testReport/' + class_name + '/' + test_name + '">' + data + '</a>';
                    }
                    return data;
                }
            }
          ],
    });

</script>

{% endblock %}
